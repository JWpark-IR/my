<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì‘ëª¨</title>
<style>
  body{font-family:"Noto Sans KR",sans-serif;background:linear-gradient(135deg,#004aad,#007bff);color:#fff;text-align:center;height:100vh;display:flex;align-items:center;justify-content:center}
  .container{background:rgba(255,255,255,0.12);padding:28px;border-radius:16px;width:340px;box-shadow:0 8px 30px rgba(0,0,0,0.2)}
  input{width:88%;padding:10px;margin:8px 0;border-radius:8px;border:none}
  button{padding:12px 22px;border-radius:30px;border:none;background:#ffd700;color:#004aad;font-weight:700;cursor:pointer;transition:all .25s}
  .flash{animation:flash .9s ease}
  @keyframes flash{0%{transform:scale(1)}50%{transform:scale(1.06)}100%{transform:scale(1)}}
  #remaining{font-weight:700;margin-top:8px}
</style>
</head>
<body>
<div class="container">
  <h2>ì£¼ì£¼ìš°ëŒ€ ì´ìš©ì</h2>
  <h2>10ë§Œëª… ê¸°ë… ì´ë²¤íŠ¸ğŸ</h2>
  <p>í•˜ë£¨ 3ë²ˆ ë§¤ì¼ ì‘ëª¨ ê°€ëŠ¥!</p>
  <p>ì‘ëª¨ í›„ <u>3ì´ˆ</u> ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!</p>
  <input id="name" placeholder="ì´ë¦„" />
  <input id="phone" placeholder="íœ´ëŒ€í°ë²ˆí˜¸(- ì œì™¸í•˜ê³  ìˆ«ìë§Œ)" />
  <div>
    <button id="applyBtn" onclick="submitForm()">ì‘ëª¨í•˜ê¸°</button>
  </div>
  <p id="remaining">ë‚¨ì€ ì‘ëª¨: -</p>
  <p id="resultMsg"></p>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwxeFBNxThXfvA6sxO9tHIfF6KH3ZYtzz6q-7j5Zz2hpfJeLJIrxXFaKP7DxDKC7W7W/exec";
const MAX_TRIES = 3;

// âœ… í•œêµ­ ì‹œê°„ ê¸°ì¤€ ì˜¤ëŠ˜ ë‚ ì§œ key ìƒì„±
function getTodayKey() {
  const now = new Date();
  const tzOffset = 9 * 60 * 60000; // +9ì‹œê°„
  const todayKST = new Date(now.getTime() + tzOffset);
  const yyyy = todayKST.getUTCFullYear();
  const mm = String(todayKST.getUTCMonth() + 1).padStart(2, '0');
  const dd = String(todayKST.getUTCDate()).padStart(2, '0');
  return `tries_${yyyy}-${mm}-${dd}`;
}

// âœ… ì‘ëª¨ íšŸìˆ˜ ê´€ë¦¬
function getTryCount() {
  return parseInt(localStorage.getItem(getTodayKey()) || "0");
}

function setTryCount(count) {
  localStorage.setItem(getTodayKey(), count);
}

function updateRemainingDisplay() {
  const remaining = MAX_TRIES - getTryCount();
  document.getElementById("remaining").innerText = `ë‚¨ì€ ì‘ëª¨: ${remaining}íšŒ`;
}

// âœ… í¼ ì œì¶œ í•¨ìˆ˜
async function submitForm() {
  const name = document.getElementById("name").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const btn = document.getElementById("applyBtn");
  const msg = document.getElementById("resultMsg");

  if (!name || !phone) {
    msg.innerText = "ì´ë¦„ê³¼ ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
    return;
  }

  const currentCount = getTryCount();
  if (currentCount >= MAX_TRIES) {
    msg.innerText = "ì˜¤ëŠ˜ ì‘ëª¨ íšŸìˆ˜ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ë‚´ì¼ ë‹¤ì‹œ ì‘ëª¨í•˜ì„¸ìš”.";
    return;
  }

  // ë²„íŠ¼ ë°˜ì§ ì• ë‹ˆë©”ì´ì…˜
  btn.classList.add('flash');
  setTimeout(()=>btn.classList.remove('flash'),900);

  // ì „ì†¡ ë°ì´í„°
  const payload = { 
    name, 
    phone, 
    try_count: currentCount + 1, 
    date: new Date().toISOString().split('T')[0]
  };

  try {
    const res = await fetch(SCRIPT_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain" }, // JSON ëŒ€ì‹  text/plainìœ¼ë¡œ ì„¤ì •
      body: JSON.stringify(payload),
    });

    const data = await res.json().catch(() => ({ status: 'error', message: 'ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨' }));

    if (data.status === "success") {
      setTryCount(currentCount + 1); // âœ… ì„±ê³µì¼ ë•Œë§Œ ì¦ê°€
      msg.innerText = "ì •ìƒ ì‘ëª¨ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰";
    } else {
      msg.innerText = "ì˜¤ë¥˜ ë°œìƒ: " + (data.message || "ì„œë²„ ì˜¤ë¥˜");
      console.error('Server Error', data);
    }
  } catch (err) {
    console.error('fetch error', err);
    msg.innerText = "ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
    // âœ… ì„œë²„ ì—ëŸ¬ ì‹œ ì‘ëª¨íšŸìˆ˜ ì°¨ê° ì•ˆ í•¨
  }

  updateRemainingDisplay();
}

updateRemainingDisplay();
</script>
</body>
</html>
