<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì‘ëª¨</title>
<style>
  body{font-family:"Noto Sans KR",sans-serif;background:linear-gradient(135deg,#004aad,#007bff);color:#fff;text-align:center;height:100vh;display:flex;align-items:center;justify-content:center}
  .container{background:rgba(255,255,255,0.12);padding:28px;border-radius:16px;width:340px;box-shadow:0 8px 30px rgba(0,0,0,0.2)}
  input{width:88%;padding:10px;margin:8px 0;border-radius:8px;border:none}
  button{padding:12px 22px;border-radius:30px;border:none;background:#ffd700;color:#004aad;font-weight:700;cursor:pointer;transition:all .25s}
  .flash{animation:flash .9s ease}
  @keyframes flash{0%{transform:scale(1)}50%{transform:scale(1.06)}100%{transform:scale(1)}}
  #remaining{font-weight:700;margin-top:8px}
</style>
</head>
<body>
<div class="container">
  <h2>ì£¼ì£¼ìš°ëŒ€ ì´ìš©ì</h2>
  <h2></h2>10ë§Œëª… ê¸°ë… ì´ë²¤íŠ¸</h2>
  <p>í•˜ë£¨ 3ë²ˆê¹Œì§€ ì‘ëª¨ ê°€ëŠ¥!</p>
  <p>ì‘ëª¨ í›„ 3ì´ˆ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!</p>
  <input id="name" placeholder="ì´ë¦„" />
  <input id="phone" placeholder="íœ´ëŒ€í° (ìˆ«ìë§Œ)" />
  <div>
    <button id="applyBtn" onclick="submitForm()">ì‘ëª¨í•˜ê¸°</button>
  </div>
  <p id="remaining">ë‚¨ì€ ì‘ëª¨: -</p>
  <p id="resultMsg"></p>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwxeFBNxThXfvA6sxO9tHIfF6KH3ZYtzz6q-7j5Zz2hpfJeLJIrxXFaKP7DxDKC7W7W/exec";
const MAX_TRIES = 3;

// ì˜¤ëŠ˜ ë‚ ì§œ í‚¤ ìƒì„± (í•œêµ­ì‹œê°„ ê¸°ì¤€)
function getTodayKey() {
  const now = new Date();
  const tzOffset = 9 * 60 * 60000; // +9ì‹œê°„
  const todayKST = new Date(now.getTime() + tzOffset);
  const yyyy = todayKST.getUTCFullYear();
  const mm = String(todayKST.getUTCMonth() + 1).padStart(2, '0');
  const dd = String(todayKST.getUTCDate()).padStart(2, '0');
  return `tries_${yyyy}-${mm}-${dd}`;
}

// í˜„ì¬ ì‘ëª¨íšŸìˆ˜ ê°€ì ¸ì˜¤ê¸°
function getTryCount() {
  const todayKey = getTodayKey();
  const storedDate = localStorage.getItem('lastDate');
  // ë‚ ì§œê°€ ë°”ë€Œë©´ ìë™ ë¦¬ì…‹
  if (storedDate !== todayKey) {
    localStorage.clear();
    localStorage.setItem('lastDate', todayKey);
    return 0;
  }
  return parseInt(localStorage.getItem(todayKey) || '0', 10);
}

// ì‘ëª¨íšŸìˆ˜ ì €ì¥
function setTryCount(n) {
  const todayKey = getTodayKey();
  localStorage.setItem(todayKey, n);
  localStorage.setItem('lastDate', todayKey);
  updateRemainingDisplay();
}

function updateRemainingDisplay() {
  const rem = Math.max(0, MAX_TRIES - getTryCount());
  document.getElementById('remaining').innerText = `ë‚¨ì€ ì‘ëª¨: ${rem}íšŒ`;
}

async function submitForm() {
  const name = document.getElementById("name").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const btn = document.getElementById("applyBtn");
  const msg = document.getElementById("resultMsg");

  if (!name || !phone) {
    msg.innerText = "ì´ë¦„ê³¼ ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
    return;
  }

  const currentCount = getTryCount();
  if (currentCount >= MAX_TRIES) {
    msg.innerText = "ì˜¤ëŠ˜ ì‘ëª¨ íšŸìˆ˜ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ë‚´ì¼ ë‹¤ì‹œ ì‘ëª¨í•˜ì„¸ìš”.";
    return;
  }

  // ë²„íŠ¼ ì• ë‹ˆ
  btn.classList.add('flash');
  setTimeout(()=>btn.classList.remove('flash'),900);

  // ìš”ì²­: Content-Typeì„ text/plainìœ¼ë¡œ ì„¤ì • -> preflight íšŒí”¼
  let payload = { name, phone, try_count: currentCount + 1, date: new Date().toISOString().split('T')[0] };

  try {
    const res = await fetch(SCRIPT_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain" }, // <-- ì¤‘ìš”: application/json ëŒ€ì‹  text/plain
      body: JSON.stringify(payload),
    });

    const data = await res.json().catch(()=>({ status: 'error', message: 'ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨ (non-json)' }));

    if (data.status === "success") {
      // ì„±ê³µì¼ ë•Œë§Œ ì¹´ìš´íŠ¸ ì¦ê°€
      setTryCount(currentCount + 1);
      msg.innerText = "ì •ìƒ ì‘ëª¨ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰";
    } else {
      // ì„œë²„ê°€ ì—ëŸ¬ë¥¼ ì¤Œ -> ì¹´ìš´íŠ¸ ë³€ê²½ ì•ˆí•¨
      msg.innerText = "ì˜¤ë¥˜ ë°œìƒ: " + (data.message || "ì„œë²„ ì˜¤ë¥˜");
      console.error('server error body', data);
    }
  } catch (err) {
    console.error('fetch error', err);
    msg.innerText = "ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
    // ë„¤íŠ¸ì›Œí¬/ì„œë²„ ì—ëŸ¬ ë°œìƒ ì‹œ ì¹´ìš´íŠ¸ëŠ” ê±´ë“œë¦¬ì§€ ì•ŠìŒ
  }
}

updateRemainingDisplay();
</script>
</body>
</html>


